const API_URL="http://ouo.freeserver.tw:24068";let currentUser=null;const urlParams=new URLSearchParams(window.location.search);let currentChannel=urlParams.get("channel")||"channel1",isAdmin,adminSessionId,adminSessionCheckTimer,lastMessageTime=0,channels=[{id:"channel1",name:"頻道 1"},{id:"channel2",name:"頻道 2"}],isThemeMenuOpen=!1,checkpasswordflag=!0,channelUnreadStatus={},notificationSettings={},channelLastReadTime={},currentMessageController=null,isUserAtBottom=!0,messageRetryCount=0,announcementRetryCount=0;const MAX_RETRY_COUNT=5,commonEmojis={common:["\uD83D\uDE00","\uD83D\uDE01","\uD83D\uDE02","\uD83E\uDD23","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE05","\uD83D\uDE06","\uD83D\uDE09","\uD83D\uDE0A","\uD83D\uDE0B","\uD83D\uDE0E","\uD83D\uDE0D","\uD83D\uDE18","\uD83E\uDD70","\uD83D\uDE17","\uD83D\uDE19","\uD83D\uDE1A","\uD83D\uDE42","\uD83E\uDD17","\uD83E\uDD14","\uD83E\uDD28","\uD83D\uDE10","\uD83D\uDE11","\uD83D\uDE36","\uD83D\uDE44","\uD83D\uDE0F","\uD83D\uDE23","\uD83D\uDE25","\uD83D\uDE2E","\uD83E\uDD10","\uD83D\uDE2F","\uD83D\uDE2A","\uD83D\uDE2B","\uD83D\uDE34","\uD83D\uDE0C","\uD83D\uDE1B","\uD83D\uDE1C","\uD83D\uDE1D","\uD83E\uDD24","\uD83D\uDE12","\uD83D\uDE13","\uD83D\uDE14","\uD83D\uDE15","\uD83D\uDE43","\uD83E\uDD11","\uD83D\uDE32","☹️","\uD83D\uDE41","\uD83D\uDE16","\uD83D\uDE1E","\uD83D\uDE1F","\uD83D\uDE24","\uD83D\uDE22","\uD83D\uDE2D","\uD83D\uDE26","\uD83D\uDE27","\uD83D\uDE28","\uD83D\uDE29","\uD83E\uDD2F","\uD83D\uDE2C","\uD83D\uDE30","\uD83D\uDE31","\uD83E\uDD75","\uD83E\uDD76","\uD83D\uDE33","\uD83E\uDD2A","\uD83D\uDE35","\uD83D\uDE21","\uD83D\uDE20","\uD83E\uDD2C","\uD83D\uDE37","\uD83E\uDD12","\uD83E\uDD15","\uD83E\uDD22","\uD83E\uDD2E","\uD83E\uDD27","\uD83D\uDE07","\uD83E\uDD73","\uD83E\uDD74","\uD83E\uDD7A","\uD83E\uDD20","\uD83E\uDD21","\uD83E\uDD25","\uD83E\uDD2B","\uD83E\uDD2D","\uD83E\uDDD0","\uD83E\uDD13","\uD83D\uDE08","\uD83D\uDC7F","\uD83D\uDC79","\uD83D\uDC7A","\uD83D\uDC80","\uD83D\uDC7B","\uD83D\uDC7D","\uD83D\uDCA9"],gestures:["\uD83D\uDC4B","\uD83E\uDD1A","\uD83D\uDD90️","✋","\uD83D\uDD96","\uD83D\uDC4C","\uD83E\uDD0C","\uD83E\uDD0F","✌️","\uD83E\uDD1E","\uD83E\uDD1F","\uD83E\uDD18","\uD83E\uDD19","\uD83D\uDC48","\uD83D\uDC49","\uD83D\uDC46","\uD83D\uDD95","\uD83D\uDC47","☝️","\uD83D\uDC4D","\uD83D\uDC4E","✊","\uD83D\uDC4A","\uD83E\uDD1B","\uD83E\uDD1C","\uD83D\uDC4F","\uD83D\uDE4C","\uD83D\uDC50","\uD83E\uDD32","\uD83E\uDD1D","\uD83D\uDE4F","✍️","\uD83D\uDC85","\uD83E\uDD33","\uD83D\uDCAA","\uD83D\uDC42","\uD83D\uDC43","\uD83D\uDC40","\uD83D\uDC41️","\uD83D\uDC44","\uD83D\uDC45","\uD83D\uDC8B"],hearts:["❤️","\uD83E\uDDE1","\uD83D\uDC9B","\uD83D\uDC9A","\uD83D\uDC99","\uD83D\uDC9C","\uD83D\uDDA4","\uD83E\uDD0D","\uD83E\uDD0E","\uD83D\uDC94","❣️","\uD83D\uDC95","\uD83D\uDC9E","\uD83D\uDC93","\uD83D\uDC97","\uD83D\uDC96","\uD83D\uDC98","\uD83D\uDC9D","\uD83D\uDC9F","\uD83D\uDC8C","\uD83D\uDCA4","\uD83D\uDCA2","\uD83D\uDCA3","\uD83D\uDCA5","\uD83D\uDCA6","\uD83D\uDCA8","\uD83D\uDCAB","\uD83D\uDCAC","\uD83D\uDDEF️","\uD83D\uDCAD","\uD83D\uDD25","✨"],objects:["\uD83D\uDD25","✨","\uD83D\uDCAB","\uD83C\uDF1F","⚡","☀️","\uD83C\uDF19","⭐","\uD83C\uDF89","\uD83C\uDF8A","\uD83C\uDF88","\uD83C\uDF82","\uD83C\uDF81","\uD83C\uDF55","\uD83C\uDF54","\uD83C\uDF5F","\uD83E\uDD64","\uD83C\uDF7A","\uD83C\uDF77","☕","\uD83C\uDF75","\uD83C\uDF4E","\uD83C\uDF4A","\uD83C\uDF49"],travel:["\uD83C\uDFE0","\uD83C\uDFE1","\uD83C\uDFE2","\uD83C\uDFE3","\uD83C\uDFE4","\uD83C\uDFE5","\uD83C\uDFE6","\uD83C\uDFE8","\uD83C\uDFE9","\uD83C\uDFEA","\uD83C\uDFEB","\uD83C\uDFEC","\uD83C\uDFED","\uD83C\uDFEF","\uD83C\uDFF0","\uD83D\uDC92","\uD83D\uDDFC","\uD83D\uDDFD","⛪","\uD83D\uDD4C","\uD83D\uDD4D","⛩️","\uD83D\uDD4B","⛲","⛺","\uD83C\uDF01","\uD83C\uDF03","\uD83C\uDF04","\uD83C\uDF05","\uD83C\uDF06","\uD83C\uDF07","\uD83C\uDF09","\uD83C\uDF0C","\uD83C\uDFA0","\uD83C\uDFA1","\uD83C\uDFA2","\uD83D\uDE82","\uD83D\uDE83","\uD83D\uDE84","\uD83D\uDE85","\uD83D\uDE86","\uD83D\uDE87","\uD83D\uDE88","\uD83D\uDE89","\uD83D\uDE8A","\uD83D\uDE9D","\uD83D\uDE9E","\uD83D\uDE8B","\uD83D\uDE8C","\uD83D\uDE8D","\uD83D\uDE8E","\uD83D\uDE90","\uD83D\uDE91","\uD83D\uDE92","\uD83D\uDE93","\uD83D\uDE94","\uD83D\uDE95","\uD83D\uDE96","\uD83D\uDE97","\uD83D\uDE98","\uD83D\uDE99","\uD83D\uDE9A","\uD83D\uDE9B","\uD83D\uDE9C","\uD83D\uDEF4","\uD83D\uDEB2","\uD83D\uDEF5","\uD83C\uDFCD️","⛵","\uD83D\uDEA4","\uD83D\uDEF3️","⛴️","\uD83D\uDEA2","✈️","\uD83D\uDEE9️","\uD83D\uDEEB","\uD83D\uDEEC","\uD83D\uDE81","\uD83D\uDE80"],animals:["\uD83D\uDC36","\uD83D\uDC31","\uD83D\uDC2D","\uD83D\uDC39","\uD83D\uDC30","\uD83D\uDC3B","\uD83D\uDC3C","\uD83D\uDC28","\uD83D\uDC2F","\uD83E\uDD81","\uD83D\uDC2E","\uD83D\uDC37","\uD83D\uDC3D","\uD83D\uDC38","\uD83D\uDC35","\uD83E\uDD8A","\uD83D\uDC3A","\uD83D\uDC17","\uD83D\uDC34","\uD83E\uDD84","\uD83D\uDC14","\uD83D\uDC27","\uD83D\uDC26","\uD83D\uDC24","\uD83D\uDC23","\uD83E\uDD89","\uD83E\uDD87","\uD83D\uDC0D","\uD83E\uDD95","\uD83E\uDD96","\uD83D\uDC19","\uD83E\uDD91","\uD83E\uDD80","\uD83E\uDD9E","\uD83D\uDC21","\uD83D\uDC2C","\uD83D\uDC33","\uD83D\uDC1F","\uD83D\uDC25","\uD83E\uDD86","\uD83E\uDD85",,"\uD83D\uDC1D","\uD83D\uDC1B","\uD83E\uDD8B","\uD83D\uDC0C","\uD83D\uDC1E","\uD83D\uDC1C"],nature:["\uD83C\uDF35","\uD83C\uDF84","\uD83C\uDF32","\uD83C\uDF33","\uD83C\uDF34","\uD83C\uDF31","\uD83C\uDF3F","☘️","\uD83C\uDF40","\uD83C\uDF41","\uD83C\uDF42","\uD83C\uDF43","\uD83C\uDF3A","\uD83C\uDF38","\uD83C\uDF3C","\uD83C\uDF3B","\uD83C\uDF1E","\uD83C\uDF1D","\uD83C\uDF1B","\uD83C\uDF1C","\uD83C\uDF1A","\uD83C\uDF15","\uD83C\uDF16","\uD83C\uDF17","\uD83C\uDF18","\uD83C\uDF11","\uD83C\uDF12","\uD83C\uDF13","\uD83C\uDF14","\uD83C\uDF19","\uD83C\uDF0E","\uD83C\uDF0D","\uD83C\uDF0F","\uD83D\uDCAB","⭐","\uD83C\uDF1F","✨","⚡","☄️","\uD83D\uDCA5","\uD83D\uDD25","\uD83C\uDF08","☀️","\uD83C\uDF24️","⛅","\uD83C\uDF25️","☁️","\uD83C\uDF26️","\uD83C\uDF27️","⛈️","\uD83C\uDF29️","\uD83C\uDF28️","❄️","☃️","⛄","\uD83D\uDCA7","\uD83D\uDCA6","☔","\uD83C\uDF0A"],sports:["⚽","\uD83C\uDFC0","\uD83C\uDFC8","⚾","\uD83E\uDD4E","\uD83C\uDFBE","\uD83C\uDFD0","\uD83C\uDFC9","\uD83C\uDFB1","\uD83C\uDFD3","\uD83C\uDFF8","\uD83C\uDFD2","\uD83C\uDFD1","\uD83C\uDFCF","\uD83E\uDD45","⛳","\uD83C\uDFF9","\uD83C\uDFA3","\uD83E\uDD4A","\uD83E\uDD4B","\uD83C\uDFBD","\uD83D\uDEF9","⛸️","\uD83C\uDFBF","⛷️","\uD83C\uDFC2","\uD83C\uDFCB️‍♀️","\uD83C\uDFCB️‍♂️","\uD83E\uDD3C‍♀️","\uD83E\uDD3C‍♂️","\uD83E\uDD38‍♀️","\uD83E\uDD38‍♂️","⛹️‍♀️","⛹️‍♂️","\uD83E\uDD3A","\uD83E\uDD3E‍♀️","\uD83E\uDD3E‍♂️","\uD83C\uDFCC️‍♀️","\uD83C\uDFCC️‍♂️","\uD83C\uDFC7","\uD83E\uDDD8‍♀️","\uD83E\uDDD8‍♂️","\uD83C\uDFC4‍♀️","\uD83C\uDFC4‍♂️","\uD83C\uDFCA‍♀️","\uD83C\uDFCA‍♂️","\uD83E\uDD3D‍♀️","\uD83E\uDD3D‍♂️","\uD83D\uDEA3‍♀️","\uD83D\uDEA3‍♂️","\uD83E\uDDD7‍♀️","\uD83E\uDDD7‍♂️","\uD83D\uDEB5‍♀️","\uD83D\uDEB5‍♂️","\uD83D\uDEB4‍♀️","\uD83D\uDEB4‍♂️","\uD83C\uDFC6","\uD83E\uDD47","\uD83E\uDD48","\uD83E\uDD49","\uD83C\uDFC5","\uD83C\uDF96️","\uD83C\uDFF5️","\uD83C\uDFAA","\uD83C\uDFAD","\uD83C\uDFA8","\uD83C\uDFAC","\uD83C\uDFA4","\uD83C\uDFA7","\uD83C\uDFBC","\uD83C\uDFB9","\uD83E\uDD41","\uD83C\uDFB7","\uD83C\uDFBA","\uD83C\uDFB8","\uD83C\uDFBB","\uD83C\uDFB2","\uD83C\uDFAF","\uD83C\uDFB3","\uD83C\uDFAE"],foods:["\uD83C\uDF4F","\uD83C\uDF4E","\uD83C\uDF50","\uD83C\uDF4A","\uD83C\uDF4B","\uD83C\uDF4C","\uD83C\uDF49","\uD83C\uDF47","\uD83C\uDF53","\uD83C\uDF48","\uD83C\uDF52","\uD83C\uDF51","\uD83C\uDF4D","\uD83E\uDD5D","\uD83C\uDF45","\uD83E\uDD51","\uD83E\uDD66","\uD83E\uDD6C","\uD83E\uDD52","\uD83C\uDF36️","\uD83C\uDF3D","\uD83E\uDD55","\uD83E\uDDC4","\uD83E\uDDC5","\uD83E\uDD54","\uD83C\uDF60","\uD83E\uDD50","\uD83E\uDD6F","\uD83C\uDF5E","\uD83E\uDD56","\uD83E\uDD68","\uD83E\uDDC0","\uD83E\uDD5A","\uD83C\uDF73","\uD83E\uDDC8","\uD83E\uDD5E","\uD83E\uDD53","\uD83E\uDD69","\uD83C\uDF57","\uD83C\uDF56","\uD83C\uDF2D","\uD83C\uDF54","\uD83C\uDF5F","\uD83C\uDF55","\uD83E\uDD6A","\uD83C\uDF2E","\uD83C\uDF2F","\uD83E\uDD57","\uD83E\uDD58","\uD83C\uDF5D","\uD83C\uDF5C","\uD83C\uDF72","\uD83C\uDF5B","\uD83C\uDF63","\uD83C\uDF71","\uD83E\uDD5F","\uD83C\uDF64","\uD83C\uDF59","\uD83C\uDF5A","\uD83C\uDF58","\uD83C\uDF65","\uD83E\uDD60","\uD83C\uDF62","\uD83C\uDF61","\uD83C\uDF67","\uD83C\uDF68","\uD83C\uDF66","\uD83C\uDF70","\uD83C\uDF82","\uD83E\uDDC1","\uD83E\uDD67","\uD83C\uDF6E","\uD83C\uDF6D","\uD83C\uDF6C","\uD83C\uDF6B","\uD83C\uDF7F","\uD83C\uDF69","\uD83C\uDF6A","\uD83E\uDD5B","☕","\uD83C\uDF75","\uD83C\uDF76","\uD83C\uDF7A","\uD83C\uDF7B","\uD83E\uDD42","\uD83C\uDF77","\uD83E\uDD43","\uD83C\uDF78","\uD83C\uDF79","\uD83C\uDF7E","\uD83E\uDDCA","\uD83E\uDD44","\uD83C\uDF74","\uD83C\uDF7D️"],objectEmojis:["⌚","\uD83D\uDCF1","\uD83D\uDCF2","\uD83D\uDCBB","⌨️","\uD83D\uDDA5️","\uD83D\uDDA8️","\uD83D\uDDB1️","\uD83D\uDCF7","\uD83D\uDCF8","\uD83D\uDCF9","\uD83C\uDFA5","\uD83D\uDCFD️","\uD83C\uDF9E️","\uD83D\uDCDE","☎️","\uD83D\uDCDF","\uD83D\uDCE0","\uD83D\uDCFA","\uD83D\uDCFB","\uD83C\uDF99️","\uD83C\uDF9A️","\uD83C\uDF9B️","⏱️","⏲️","⏰","\uD83D\uDD70️","⌛","⏳","\uD83D\uDCE1","\uD83D\uDD0B","\uD83D\uDD0C","\uD83D\uDCA1","\uD83D\uDD26","\uD83D\uDD6F️","\uD83D\uDCB8","\uD83D\uDCB5","\uD83D\uDCB4","\uD83D\uDCB6","\uD83D\uDCB7","\uD83D\uDCB0","\uD83D\uDCB3","\uD83D\uDC8E","⚖️","\uD83D\uDD27","\uD83D\uDD28","⚒️","\uD83D\uDEE0️","⛏️","\uD83D\uDD29","⚙️","⛓️","\uD83D\uDD2B","\uD83D\uDCA3","\uD83D\uDD2A","\uD83D\uDDE1️","⚔️","\uD83D\uDEE1️","\uD83D\uDEAC","⚰️","⚱️","\uD83C\uDFFA","\uD83D\uDD2E","\uD83D\uDCFF","\uD83D\uDC88","⚗️","\uD83D\uDD2D","\uD83D\uDD2C","\uD83D\uDD73️","\uD83D\uDC8A","\uD83D\uDC89","\uD83E\uDE78","\uD83E\uDE79","\uD83E\uDE7A","\uD83D\uDEBD","\uD83D\uDEB0","\uD83D\uDEBF","\uD83D\uDEC1","\uD83D\uDEC0","\uD83E\uDDFC","\uD83E\uDDFD","\uD83E\uDDF4","\uD83D\uDC53","\uD83D\uDD76️","\uD83D\uDC54","\uD83D\uDC55","\uD83D\uDC56","\uD83E\uDDE3","\uD83E\uDDE4","\uD83E\uDDE5","\uD83E\uDDE6","\uD83D\uDC57","\uD83D\uDC58","\uD83D\uDC59","\uD83D\uDC5A","\uD83D\uDC5B","\uD83D\uDC5C","\uD83D\uDC5D","\uD83C\uDF92","\uD83D\uDC5E","\uD83D\uDC5F","\uD83E\uDD7E","\uD83E\uDD7F","\uD83D\uDC60","\uD83D\uDC61","\uD83D\uDC62","\uD83D\uDC51","\uD83D\uDC52","\uD83C\uDFA9","\uD83C\uDF93","\uD83E\uDDE2","⛑️","\uD83D\uDCFF","\uD83D\uDC84","\uD83D\uDC8D","\uD83D\uDC8E"],flags:["\uD83C\uDDF9\uD83C\uDDFC","\uD83C\uDDE8\uD83C\uDDF3","\uD83C\uDDED\uD83C\uDDF0","\uD83C\uDDF2\uD83C\uDDF4","\uD83C\uDDEF\uD83C\uDDF5","\uD83C\uDDF0\uD83C\uDDF7","\uD83C\uDDF5\uD83C\uDDED","\uD83C\uDDFB\uD83C\uDDF3","\uD83C\uDDF2\uD83C\uDDFE","\uD83C\uDDF8\uD83C\uDDEC","\uD83C\uDDEE\uD83C\uDDE9","\uD83C\uDDF9\uD83C\uDDED","\uD83C\uDDFA\uD83C\uDDF8","\uD83C\uDDEC\uD83C\uDDE7","\uD83C\uDDEB\uD83C\uDDF7","\uD83C\uDDE9\uD83C\uDDEA","\uD83C\uDDEE\uD83C\uDDF9","\uD83C\uDDE8\uD83C\uDDE6","\uD83C\uDDE6\uD83C\uDDFA","\uD83C\uDDF3\uD83C\uDDFF","\uD83C\uDDEE\uD83C\uDDF3","\uD83C\uDDF7\uD83C\uDDFA","\uD83C\uDDE7\uD83C\uDDF7"]};function setupChannelToggle(){let e=document.getElementById("toggle-channels"),n=document.querySelector(".channels");window.innerWidth<=576&&(n.classList.add("collapsed"),e.classList.add("collapsed")),e.addEventListener("click",t=>{n.classList.toggle("collapsed"),e.classList.toggle("collapsed"),t.stopPropagation()}),window.addEventListener("resize",()=>{window.innerWidth<=576?n.classList.contains("collapsed")||(n.classList.add("collapsed"),e.classList.add("collapsed")):(n.classList.remove("collapsed"),e.classList.remove("collapsed"))}),document.addEventListener("click",t=>{if(window.innerWidth<=576){let s=n.contains(t.target),a=e.contains(t.target);s||a||n.classList.contains("collapsed")||(n.classList.add("collapsed"),e.classList.add("collapsed"))}}),updateChannelHeader()}function createNotificationContainer(){let e=document.createElement("div");e.id="notification-container",e.className="notification-container",document.body.appendChild(e)}function showNotification(e,n="info",t=3e3){let s=document.getElementById("notification-container"),a=document.createElement("div");a.className=`notification notification-${n}`;let i="";switch(n){case"success":i='<i class="fas fa-check-circle"></i>';break;case"error":i='<i class="fas fa-exclamation-circle"></i>';break;case"warning":i='<i class="fas fa-exclamation-triangle"></i>';break;default:i='<i class="fas fa-info-circle"></i>'}a.innerHTML=`${i} <span>${e}</span>`;let o=document.createElement("button");return o.className="notification-close",o.innerHTML="&times;",o.addEventListener("click",()=>{a.classList.add("notification-hide"),setTimeout(()=>{s.removeChild(a)},300)}),a.appendChild(o),s.appendChild(a),setTimeout(()=>{a.classList.add("notification-show")},10),t>0&&setTimeout(()=>{a.classList.add("notification-hide"),setTimeout(()=>{a.parentNode===s&&s.removeChild(a)},300)},t),a}function showNetworkErrorNotification(){let e=showNotification("網絡連接錯誤，請重新整理頁面並檢查網路連接","error",0),n=document.createElement("button");n.className="notification-refresh-btn",n.innerHTML='<i class="fas fa-sync-alt"></i> 重新整理',n.addEventListener("click",()=>{window.location.reload()}),e.querySelector("span").appendChild(document.createElement("br")),e.querySelector("span").appendChild(n)}function loadChannels(){$.get(API_URL,{action:"getChannels"}).done(function(e){e.success&&e.channels&&(console.log("channels:",e.channels),(channels=e.channels).some(e=>e.id==currentChannel)||(currentChannel=channels[0].id),updateChannelList(),updateChannelHeader())}).fail(function(e){console.error("加載公告錯誤:",e)})}function initUser(){let e=localStorage.getItem("userId"),n=localStorage.getItem("userToken");e&&n||(e=Math.floor(1e3+9e3*Math.random()).toString(),n=Array(16).fill(0).map(()=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return e[Math.floor(Math.random()*e.length)]}).join(""),localStorage.setItem("userId",e),localStorage.setItem("userToken",n)),checkAndRegisterUserId(e,n),(adminSessionId=localStorage.getItem("adminSessionId"))?checkAdminSession():(isAdmin=!1,updateAdminUI())}function checkAndRegisterUserId(e,n){$.get(API_URL,{action:"checkUserId",userId:e,userToken:n}).done(function(t){if(t.success){if(t.exists){let s=Math.floor(1e3+9e3*Math.random()).toString();checkAndRegisterUserId(s,n)}else registerUserId(e,n)}else console.error("檢查用戶ID失敗:",t.error),setCurrentUser(e)}).fail(function(n){console.error("檢查用戶ID錯誤:",n),setCurrentUser(e)})}function registerUserId(e,n){$.post(API_URL,{action:"registerUserId",data:JSON.stringify({userId:e,userToken:n,timestamp:new Date().toISOString()})}).done(function(t){if(t.success)localStorage.setItem("userId",e),setCurrentUser(e),sendHeartbeat();else if(t.exists){let s=Math.floor(1e3+9e3*Math.random()).toString();checkAndRegisterUserId(s,n)}else console.error("註冊用戶ID失敗:",t.error),setCurrentUser(e)}).fail(function(n){console.error("註冊用戶ID錯誤:",n),setCurrentUser(e)})}function releaseUserId(){let e=localStorage.getItem("userId");e&&navigator.sendBeacon(API_URL,new URLSearchParams({action:"releaseUserId",data:JSON.stringify({userId:e})}))}function sendHeartbeat(){let e=localStorage.getItem("userId");e&&$.post(API_URL,{action:"userHeartbeat",data:JSON.stringify({userId:e,timestamp:new Date().toISOString()})}).done(function(e){e.success?console.log("心跳發送成功"):console.error("心跳發送失敗:",e.error)}).fail(function(e){console.error("心跳發送錯誤:",e)})}function setCurrentUser(e){currentUser=`User#${e}`,document.getElementById("user-name").textContent=currentUser}function initNotificationSettings(){let e=localStorage.getItem("notificationSettings");e?notificationSettings=JSON.parse(e):(channels.forEach(e=>{notificationSettings[e.id]=!0}),localStorage.setItem("notificationSettings",JSON.stringify(notificationSettings))),document.getElementById("notification-settings-toggle").addEventListener("click",toggleNotificationSettingsMenu),document.addEventListener("click",e=>{let n=document.getElementById("notification-settings-menu"),t=document.getElementById("notification-settings-toggle");n.contains(e.target)||e.target===t||t.contains(e.target)||n.classList.add("hidden")}),updateNotificationSettingsList()}function toggleChannelNotification(e){notificationSettings[e]=!notificationSettings[e],localStorage.setItem("notificationSettings",JSON.stringify(notificationSettings)),updateNotificationIcons(),updateUnreadIndicators();let n=channels.find(n=>n.id===e)?.name||e,t=notificationSettings[e]?"開啟":"關閉";showNotification(`已${t} ${n} 的通知`,"info",duration=500)}function toggleNotificationSettingsMenu(){updateNotificationSettingsList();let e=document.getElementById("notification-settings-menu");e.classList.toggle("hidden"),document.getElementById("theme-menu").classList.add("hidden"),isThemeMenuOpen=!1,document.getElementById("font-size-menu").classList.add("hidden"),document.getElementById("format-help-menu").classList.add("hidden")}function updateNotificationSettingsList(){let e=document.getElementById("channel-notification-list");if(e.innerHTML="",0===channels.length){let n=document.createElement("div");n.className="channel-notification-item",n.textContent="沒有可用的頻道",e.appendChild(n);return}channels.forEach(n=>{let t=document.createElement("div");t.className="channel-notification-item";let s=document.createElement("span");s.textContent=n.name;let a=document.createElement("button");a.className="channel-notification-toggle",a.dataset.channel=n.id,notificationSettings[n.id]?(a.innerHTML='<i class="fas fa-bell"></i>',a.title="關閉通知"):(a.innerHTML='<i class="fas fa-bell-slash"></i>',a.title="開啟通知"),a.addEventListener("click",()=>{toggleChannelNotification(n.id)}),t.appendChild(s),t.appendChild(a),e.appendChild(t)})}function updateNotificationIcons(){document.querySelectorAll(".channel-notification-toggle").forEach(e=>{let n=e.dataset.channel;notificationSettings[n]?(e.innerHTML='<i class="fas fa-bell"></i>',e.title="關閉通知"):(e.innerHTML='<i class="fas fa-bell-slash"></i>',e.title="開啟通知")})}function setupEventListeners(){window.addEventListener("beforeunload",function(e){releaseUserId()}),window.addEventListener("unload",function(e){releaseUserId()}),document.getElementById("send-button").addEventListener("click",sendMessage);let e=document.getElementById("message-input");function n(){e.style.height="auto",e.style.height=Math.min(e.scrollHeight+2.5,150)+"px"}window.autoResizeTextarea=n,window.addEventListener("resize",n),e.addEventListener("input",n),n(),e.addEventListener("keydown",t=>{if("Enter"===t.key){if(t.shiftKey){let s=e.selectionStart,a=e.selectionEnd;e.value=e.value.substring(0,s)+"\n"+e.value.substring(a);let i=s+1;e.setSelectionRange(i,i),t.preventDefault(),n()}else t.preventDefault(),sendMessage()}n()}),document.getElementById("format-help-toggle").addEventListener("click",toggleFormatHelpMenu),document.addEventListener("click",e=>{let n=document.getElementById("format-help-menu"),t=document.getElementById("format-help-toggle");n.contains(e.target)||e.target===t||t.contains(e.target)||n.classList.add("hidden")}),document.addEventListener("click",function(e){e.target.classList.contains("spoiler")&&e.target.classList.toggle("revealed")}),document.querySelectorAll(".channel").forEach(e=>{e.addEventListener("click",()=>{switchChannel(e.dataset.channel)})}),document.getElementById("theme-toggle").addEventListener("click",toggleThemeMenu),document.getElementById("theme-light").addEventListener("click",()=>{setTheme("light"),toggleThemeMenu()}),document.getElementById("theme-gray").addEventListener("click",()=>{setTheme("gray"),toggleThemeMenu()}),document.getElementById("theme-dark").addEventListener("click",()=>{setTheme("dark"),toggleThemeMenu()}),document.getElementById("theme-green").addEventListener("click",()=>{setTheme("green"),toggleThemeMenu()}),document.getElementById("theme-purple").addEventListener("click",()=>{setTheme("purple"),toggleThemeMenu()}),document.getElementById("font-size-toggle").addEventListener("click",toggleFontSizeMenu),document.getElementById("font-size-small").addEventListener("click",()=>{setFontSize("small"),toggleFontSizeMenu()}),document.getElementById("font-size-medium").addEventListener("click",()=>{setFontSize("medium"),toggleFontSizeMenu()}),document.getElementById("font-size-large").addEventListener("click",()=>{setFontSize("large"),toggleFontSizeMenu()}),document.addEventListener("click",e=>{let n=document.getElementById("theme-menu"),t=document.getElementById("theme-toggle"),s=document.getElementById("font-size-menu"),a=document.getElementById("font-size-toggle");n.contains(e.target)||e.target===t||t.contains(e.target)||(n.classList.add("hidden"),isThemeMenuOpen=!1),s.contains(e.target)||e.target===a||a.contains(e.target)||s.classList.add("hidden")}),document.getElementById("admin-login").addEventListener("click",showAdminModal),document.getElementById("admin-form").addEventListener("submit",handleAdminLogin),document.getElementById("add-channel").addEventListener("click",showAddChannelModal),document.getElementById("channel-form").addEventListener("submit",handleChannelForm),document.querySelectorAll(".close").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".modal").forEach(e=>{e.classList.add("hidden")})})});let t=document.querySelector(".marquee-container"),s=document.createElement("button");s.id="edit-announcement",s.className="edit-announcement-btn admin-only hidden",s.innerHTML='<i class="fas fa-edit"></i>',s.title="編輯公告",s.addEventListener("click",()=>{showAnnouncementModal()}),t.appendChild(s),document.getElementById("announcement-form").addEventListener("submit",handleAnnouncementForm),document.getElementById("emoji-button").addEventListener("click",toggleEmojiPicker),document.addEventListener("click",e=>{let n=document.querySelector(".emoji-picker"),t=document.querySelector(".emoji-picker-toggle");n.contains(e.target)||t.contains(e.target)||n.classList.add("hidden")});let a=localStorage.getItem("theme")||"light",i=localStorage.getItem("fontSize")||"small";setTheme(a),setFontSize(i);let o=document.getElementById("messages");o.addEventListener("scroll",()=>{let e=o.scrollHeight,n=o.clientHeight,t=o.scrollTop;isUserAtBottom=t+n>=e-10})}function setupEmojiPicker(){let e=document.getElementById("emoji-picker");e.innerHTML="";let n=document.createElement("div");n.classList.add("emoji-tabs"),e.appendChild(n);let t=document.createElement("div");t.classList.add("emoji-container"),e.appendChild(t);let s=!0;Object.entries(commonEmojis).forEach(([e,a])=>{let i=document.createElement("div");i.classList.add("emoji-tab"),s&&(i.classList.add("active"),s=!1);let o="";switch(e){case"common":default:o="\uD83D\uDE00";break;case"gestures":o="\uD83D\uDC4D";break;case"hearts":o="❤️";break;case"objects":o="\uD83C\uDF81";break;case"travel":o="✈️";break;case"animals":o="\uD83D\uDC31";break;case"nature":o="\uD83C\uDF3F";break;case"sports":o="⚽";break;case"foods":o="\uD83C\uDF54";break;case"objectEmojis":o="\uD83D\uDCF1";break;case"flags":o="\uD83C\uDDF9\uD83C\uDDFC"}i.textContent=o,i.dataset.category=e,n.appendChild(i);let l=document.createElement("div");l.classList.add("emoji-category"),l.dataset.category=e,!1===s&&e===Object.keys(commonEmojis)[0]?l.classList.add("active"):l.classList.add("hidden"),a.forEach(n=>{let t=document.createElement("div");t.classList.add("emoji"),"flags"===e?(t.textContent=n,t.classList.add("flag-emoji")):t.textContent=n,t.addEventListener("click",()=>{let e=document.getElementById("message-input");e.value+=n,e.focus()}),l.appendChild(t)}),t.appendChild(l)}),document.querySelectorAll(".emoji-tab").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".emoji-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active");let n=e.dataset.category;document.querySelectorAll(".emoji-category").forEach(e=>{e.dataset.category===n?e.classList.remove("hidden"):e.classList.add("hidden")})})})}function toggleEmojiPicker(){let e=document.getElementById("emoji-picker");e.classList.toggle("hidden")}function toggleThemeMenu(){let e=document.getElementById("theme-menu");e.classList.toggle("hidden"),isThemeMenuOpen=!isThemeMenuOpen,document.getElementById("font-size-menu").classList.add("hidden")}function toggleFontSizeMenu(){let e=document.getElementById("font-size-menu");e.classList.toggle("hidden"),document.getElementById("theme-menu").classList.add("hidden"),isThemeMenuOpen=!1,document.getElementById("format-help-menu").classList.add("hidden")}function toggleFormatHelpMenu(){let e=document.getElementById("format-help-menu");e.classList.toggle("hidden"),document.getElementById("theme-menu").classList.add("hidden"),isThemeMenuOpen=!1,document.getElementById("font-size-menu").classList.add("hidden")}function setTheme(e){let n=document.body.dataset.fontSize||"medium";document.body.className=`theme-${e} font-size-${n}`,document.querySelectorAll(".theme-option").forEach(e=>{e.classList.remove("active")}),document.getElementById(`theme-${e}`).classList.add("active"),localStorage.setItem("theme",e)}function setFontSize(e){let n=localStorage.getItem("theme")||"light";document.body.dataset.fontSize=e,document.body.className=`theme-${n} font-size-${e}`,document.querySelectorAll(".font-size-option").forEach(e=>{e.classList.remove("active")}),document.getElementById(`font-size-${e}`).classList.add("active"),localStorage.setItem("fontSize",e)}function switchChannel(e){if(e==currentChannel){if(updateChannelHeader(),window.innerWidth<=576){let n=document.querySelector(".channels"),t=document.getElementById("toggle-channels");n.classList.add("collapsed"),t.classList.add("collapsed")}channelUnreadStatus[e]=!1,updateUnreadIndicators(),loadMessages();return}currentMessageController&&(currentMessageController.abort(),currentMessageController=null);let s=new URL(window.location);s.searchParams.set("channel",e),window.history.replaceState({},"",s),currentChannel=e,document.querySelectorAll(".channel").forEach(n=>{n.dataset.channel===e?n.classList.add("active"):n.classList.remove("active")});let a=document.getElementById("messages");if(a.innerHTML=`
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>${channels.find(n=>n.id===e)?.name||e} 頻道載入中...</p>
        </div>
    `,updateChannelHeader(),window.innerWidth<=576){let i=document.querySelector(".channels"),o=document.getElementById("toggle-channels");i.classList.add("collapsed"),o.classList.add("collapsed")}channelUnreadStatus[e]=!1,updateUnreadIndicators(),loadMessages()}function sendMessage(){let e=document.getElementById("message-input"),n=document.getElementById("send-button"),t=e.value.trim();if(""===t)return;let s=Date.now();if(s-lastMessageTime<3e3){showNotification(`請等待 ${((s-lastMessageTime)/1e3).toFixed(1)} 秒後再發送消息`,"warning");return}lastMessageTime=s,n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i>',sendMessageToGAS(t,n),e.value="",e.focus(),autoResizeTextarea();let a=3,i=setInterval(()=>{--a>0?n.innerHTML=`<span class="cooldown-text">${a}</span>`:(clearInterval(i),n.innerHTML='<i class="fas fa-paper-plane"></i>',n.disabled=!1)},1e3)}function sendMessageToGAS(e,n){let t={sender:currentUser,content:e,channel:currentChannel,timestamp:new Date().toISOString()};$.post(API_URL,{action:"sendMessage",data:JSON.stringify(t).toString(),sessionId:adminSessionId}).done(function(e){e.success?loadMessages():(console.error("發送消息失敗:",e.error),showNotification("發送消息失敗："+(e.error||"未知錯誤"),"error"))}).fail(function(e){console.error("發送消息錯誤:",e),showNotification("發送消息錯誤，請稍後再試","error")}).always(function(){n&&(n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i>')})}function formatTimestamp(e){if(!e)return"";let n=new Date(e),t=new Date,s=n.getDate()===t.getDate()&&n.getMonth()===t.getMonth()&&n.getFullYear()===t.getFullYear(),a=n.getHours().toString().padStart(2,"0"),i=n.getMinutes().toString().padStart(2,"0"),o=`${a}:${i}`;if(!s){let l=(n.getMonth()+1).toString().padStart(2,"0"),d=n.getDate().toString().padStart(2,"0");return`${l}/${d} ${o}`}return o}function updateOnlineUsersCount(e){let n=document.getElementById("online-users-count");n&&(n.textContent=`目前上線人數: ${e}`)}function getOnlineUsersCount(){$.get(API_URL,{action:"getMessages",channel:currentChannel}).done(function(e){if(e.success){let n=e.active_users||[];updateOnlineUsersCount(n.length)}}).fail(function(e){console.error("獲取在線人數錯誤:",e)})}document.addEventListener("DOMContentLoaded",()=>{function e(e="channel-password-display"){let n=document.getElementById(e);if(!n){showNotification("找不到密碼欄位","error");return}navigator.clipboard.writeText(n.value).then(()=>{showNotification("密碼已複製到剪貼簿","success")}).catch(e=>{showNotification("無法複製密碼: "+e,"error")})}initUser(),setupEventListeners(),createNotificationContainer(),setupEmojiPicker(),setupChannelToggle(),document.getElementById("channel-password-option").addEventListener("change",function(e){let n=document.querySelector('#channel-form button[type="submit"]'),t=document.getElementById("password-display-group");e.target.checked&&t.classList.contains("hidden")?n.innerHTML="產生密碼":e.target.checked||(t.classList.add("hidden"),n.innerHTML="儲存")}),document.getElementById("copy-password-btn").addEventListener("click",function(){e()}),loadChannels(),loadAnnouncement(),initNotificationSettings(),loadMessages(),getOnlineUsersCount(),sendHeartbeat();let n=new EventSource(`${API_URL}/events`);n.onmessage=e=>{let n=JSON.parse(e.data);n.messages&&n.active_users&&updateMessages(n.messages,n.active_users),n.channels&&(channels=n.channels,updateChannelList()),n.announcement&&(document.getElementById("announcement").textContent=n.announcement)},window.heartbeatInterval=setInterval(sendHeartbeat,6e4)});let lastMessageCount=0,lastMessageTimestamp="";function loadMessages(){currentMessageController&&currentMessageController.abort();let e=channels.find(e=>e.id===currentChannel);if(e&&e.has_password&&checkpasswordflag){showPasswordModal(currentChannel),currentChannel="channel1";return}currentMessageController=new AbortController;let n=currentMessageController.signal,t=currentChannel;fetch(`${API_URL}?action=getMessages&channel=${t}`,{method:"GET",signal:n}).then(e=>e.json()).then(e=>{if(t!==currentChannel){console.log("忽略舊頻道的響應:",t);return}if(messageRetryCount=0,e.success){let n=e.messages||[];n.length>0&&n[n.length-1].timestamp,e.active_users&&updateOnlineUsersCount(e.active_users.length),currentUser?displayMessages(n):switchChannel(currentChannel)}else console.error("加載消息失敗:",e.error);currentMessageController&&!1===currentMessageController.signal.aborted&&(currentMessageController=null)}).catch(e=>{if("AbortError"===e.name){console.log("請求已取消");return}console.error("加載消息錯誤:",e),++messageRetryCount>=5?(clearInterval(window.messageInterval),showNetworkErrorNotification()):displayMockMessages(),currentMessageController=null})}function loadAnnouncement(){$.get(API_URL,{action:"getAnnouncement"}).done(function(e){announcementRetryCount=0,e.success&&e.announcement&&(document.getElementById("announcement").textContent=e.announcement)}).fail(function(e){console.error("加載公告錯誤:",e),++announcementRetryCount>=5&&(clearInterval(window.announcementInterval),showNetworkErrorNotification())})}function checkAdminSession(){if(!adminSessionId){isAdmin=!1,updateAdminUI();return}$.post(API_URL,{action:"checkAdminSession",sessionId:adminSessionId}).done(function(e){if(e.success&&e.isValid){isAdmin=!0,adminSessionCheckTimer&&clearTimeout(adminSessionCheckTimer);let n=Math.max(e.expiresIn-3e5,6e4);adminSessionCheckTimer=setTimeout(checkAdminSession,n),localStorage.setItem("adminSessionId",adminSessionId)}else adminLogout(!1);updateAdminUI()}).fail(function(e){console.error("檢查管理員會話錯誤:",e),adminLogout(!1)})}function adminLogout(e=!0){e&&adminSessionId&&$.post(API_URL,{action:"adminLogout",sessionId:adminSessionId}),localStorage.removeItem("adminSessionId"),adminSessionId=null,isAdmin=!1,adminSessionCheckTimer&&(clearTimeout(adminSessionCheckTimer),adminSessionCheckTimer=null),updateAdminUI(),e&&showNotification("已登出管理員帳戶","info")}function handleAdminLogin(e){e.preventDefault();let n=document.querySelector('#admin-form button[type="submit"]'),t=document.getElementById("admin-username").value,s=document.getElementById("admin-password").value,a=document.getElementById("admin-uniquenum").value;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> 登入中...',$.post(API_URL,{action:"adminLogin",data:JSON.stringify({username:t,password:s,uniquenum:a}).toString()}).done(function(e){if(e.success){isAdmin=!0,adminSessionId=e.sessionId,localStorage.setItem("adminSessionId",adminSessionId),adminSessionCheckTimer&&clearTimeout(adminSessionCheckTimer);let n=Math.max(e.expiresIn-3e5,6e4);adminSessionCheckTimer=setTimeout(checkAdminSession,n),updateAdminUI(),document.getElementById("admin-modal").classList.add("hidden"),showNotification("管理員登錄成功！會話將在30分鐘後過期","success")}else showNotification("登錄失敗："+(e.error||"驗證信息不正確"),"error")}).fail(function(e){console.error("登錄錯誤:",e),showNotification("登錄請求失敗，請稍後再試","error")}).always(function(){n.disabled=!1,n.innerHTML="登入"})}function addChannel(e,n){let t="channel"+(channels.length+1),s=document.getElementById("channel-password-option").checked;$.post(API_URL,{action:"addChannel",data:JSON.stringify({id:t,name:e,has_password:s}),sessionId:adminSessionId}).done(function(a){a.success?(channels.push({id:t,name:e,has_password:s}),updateChannelList(),s&&a.password?(document.getElementById("channel-password-display").value=a.password,document.getElementById("password-display-group").classList.remove("hidden"),n&&(n.disabled=!1,n.innerHTML="複製並關閉"),copyPassword(),showNotification("頻道添加成功！請複製並保存密碼，關閉後將無法再次查看","success")):(document.getElementById("channel-modal").classList.add("hidden"),showNotification("頻道添加成功！","success"))):showNotification("添加頻道失敗："+(a.error||"未知錯誤"),"error")}).fail(function(e){console.error("添加頻道錯誤:",e),showNotification("添加頻道請求失敗，請稍後再試","error")}).always(function(){n&&document.getElementById("password-display-group").classList.contains("hidden")&&(n.disabled=!1,n.innerHTML="儲存")})}function updateChannel(e,n,t){let s=document.getElementById("channel-password-option").checked;$.post(API_URL,{action:"updateChannel",data:JSON.stringify({id:e,name:n,has_password:s}),sessionId:adminSessionId}).done(function(a){if(a.success){let i=channels.findIndex(n=>n.id===e);-1!==i&&(channels[i].name=n,channels[i].has_password=s,updateChannelList()),a.password?(document.getElementById("channel-password-display").value=a.password,document.getElementById("password-display-group").classList.remove("hidden"),t&&(t.disabled=!1,t.innerHTML="複製並關閉"),showNotification("頻道更新成功！請複製並保存密碼，關閉後將無法再次查看","success")):(document.getElementById("channel-modal").classList.add("hidden"),showNotification("頻道更新成功！","success"))}else showNotification("更新頻道失敗："+(a.error||"未知錯誤"),"error")}).fail(function(e){console.error("更新頻道錯誤:",e),showNotification("更新頻道請求失敗，請稍後再試","error")}).always(function(){t&&document.getElementById("password-display-group").classList.contains("hidden")&&(t.disabled=!1,t.innerHTML="儲存")})}function showAnnouncementModal(){let e=document.getElementById("announcement-text");e.value="載入中...",document.getElementById("announcement-modal").classList.remove("hidden"),$.get(API_URL,{action:"getAnnouncement"}).done(function(n){n.success&&(e.value=n.announcement||"")}).fail(function(n){console.error("獲取公告錯誤:",n),e.value="",showNotification("獲取公告失敗，請重新嘗試","error")})}function handleAnnouncementForm(e){e.preventDefault();let n=document.querySelector('#announcement-form button[type="submit"]'),t=document.getElementById("announcement-text").value;t=t.replace(/\n\s*\n/g," ").replace(/\n/g,"	"),n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> 處理中...',$.post(API_URL,{action:"updateAnnouncement",data:`{ "announcement": "${t}" }`,sessionId:adminSessionId}).done(function(e){e.success?(document.getElementById("announcement").textContent=t,document.getElementById("announcement-modal").classList.add("hidden"),showNotification("公告更新成功！","success")):showNotification("更新公告失敗："+(e.error||"未知錯誤"),"error")}).fail(function(e){console.error("更新公告錯誤:",e),showNotification("更新公告請求失敗，請稍後再試","error")}).always(function(){n.disabled=!1,n.innerHTML="儲存"})}function updateUnreadIndicators(){document.querySelectorAll(".channel").forEach(e=>{let n=e.dataset.channel,t=e.querySelector(".unread-indicator"),s=getUnreadMessageCount(n);s>0&&n!==currentChannel&&notificationSettings[n]?(t.classList.add("show"),s>=2?t.textContent=s:t.textContent=""):(t.classList.remove("show"),t.textContent="")})}function getUnreadMessageCount(e){if(!channelUnreadStatus[e])return 0;let n=channelLastReadTime[e]||0,t=0;if(window.cachedMessages&&window.cachedMessages[e]){let s=window.cachedMessages[e];t=s.filter(e=>{let t=new Date(e.timestamp).getTime();return t>n}).length}return Math.max(t,1)}function updateMessages(e,n){n&&updateOnlineUsersCount(n.length),window.cachedMessages||(window.cachedMessages={}),e&&(Object.keys(e).forEach(n=>{let t=e[n];if(!t||0===t.length)return;window.cachedMessages[n]=t;let s=t[t.length-1],a=new Date(s.timestamp).getTime();if(n===currentChannel)displayMessages(t),channelLastReadTime[n]=a,channelUnreadStatus[n]=!1;else{let i=channelLastReadTime[n]||0;a>i&&(channelUnreadStatus[n]=!0)}}),updateUnreadIndicators())}function displayMessages(e){let n=document.getElementById("messages");if(n.innerHTML="",!e||0===e.length){let t=document.createElement("div");t.classList.add("empty-channel-message"),t.innerHTML='<i class="fas fa-comments"></i><p>此頻道還未有訊息，請開始你的交談～</p>',n.appendChild(t);return}e.forEach(e=>{let t=document.createElement("div");t.classList.add("message"),t.dataset.id=e.id||"",e.sender==currentUser&&t.classList.add("my-message");let s=document.createElement("div");s.classList.add("message-sender");let a=formatTimestamp(e.timestamp);s.textContent=`${e.sender} ${a?"\xb7 "+a:""}`;let i=document.createElement("div");if(i.classList.add("message-content"),e.deleted)i.classList.add("deleted-message"),i.innerHTML='<i class="fas fa-ban"></i> 此訊息已被管理員刪除';else if(i.innerHTML=window.parseMarkdown(e.content),isAdmin){let o=document.createElement("button");o.classList.add("delete-message-btn"),o.innerHTML='<i class="fas fa-trash-alt"></i>',o.title="刪除訊息",o.addEventListener("click",()=>{confirm("確定要刪除此訊息嗎？")&&deleteMessage(e,e.channel||currentChannel)}),i.appendChild(o)}t.appendChild(s),t.appendChild(i),n.appendChild(t)}),isUserAtBottom&&(n.scrollTop=n.scrollHeight)}function displayMockMessages(){let e=[{id:"1",sender:"User#1234",content:"你好，這是一條測試消息！",timestamp:new Date().toISOString(),deleted:!1},{id:"2",sender:currentUser,content:"這是我發送的消息",timestamp:new Date().toISOString(),deleted:!1},{id:"3",sender:"User#5678",content:"歡迎來到聊天室！",timestamp:new Date().toISOString(),deleted:!1}];displayMessages(e)}function deleteMessage(e,n){if(!isAdmin||!adminSessionId){showNotification("需要管理員權限才能刪除消息","error");return}$.post(API_URL,{action:"deleteMessage",data:JSON.stringify({content:e.content,sender:e.sender,timestamp:e.timestamp,channel:n}),sessionId:adminSessionId}).done(function(e){e.success?(loadMessages(),showNotification("消息已成功刪除","success")):showNotification("刪除消息失敗："+(e.error||"未知錯誤"),"error")}).fail(function(e){console.error("刪除消息錯誤:",e),showNotification("刪除消息請求失敗，請稍後再試","error")})}function showAdminModal(){isAdmin||document.getElementById("admin-modal").classList.remove("hidden")}function updateAdminUI(){let e=document.querySelectorAll(".admin-only"),n=document.getElementById("admin-login"),t=document.querySelector(".marquee-container");isAdmin?(e.forEach(e=>e.classList.remove("hidden")),n.innerHTML='<i class="fas fa-sign-out-alt"></i>',n.title="管理員登出",n.onclick=function(){confirm("確定要登出管理員帳戶嗎？")&&adminLogout()},updateChannelButtons(),t.classList.add("admin-mode")):(e.forEach(e=>e.classList.add("hidden")),n.innerHTML='<i class="fas fa-user-shield"></i>',n.title="管理員登入",n.onclick=showAdminModal,document.querySelectorAll(".channel-edit, .channel-delete").forEach(e=>e.remove()),t.classList.remove("admin-mode"))}function updateChannelButtons(){isAdmin&&document.querySelectorAll(".channel").forEach(e=>{let n=e.dataset.channel,t=channels.find(e=>e.id===n);if(!e.querySelector(".channel-edit")){let s=document.createElement("button");s.classList.add("channel-edit"),s.innerHTML='<i class="fas fa-edit"></i>',s.style.float="right",s.style.marginLeft="5px",s.style.background="none",s.style.border="none",s.style.cursor="pointer",s.style.color="inherit",s.addEventListener("click",e=>{e.stopPropagation(),t&&showEditChannelModal(t)}),e.appendChild(s)}if(!e.querySelector(".channel-delete")&&"channel1"!==n&&"channel2"!==n){let a=document.createElement("button");a.classList.add("channel-delete"),a.innerHTML='<i class="fas fa-trash"></i>',a.style.float="right",a.style.background="none",a.style.border="none",a.style.cursor="pointer",a.style.color="inherit",a.addEventListener("click",e=>{e.stopPropagation(),confirm(`確定要刪除頻道 "${t.name}" 嗎？此操作不可恢復。`)&&deleteChannel(n)}),e.appendChild(a)}})}function updateChannelList(){let e=document.getElementById("channel-list");e.innerHTML="",channels.forEach(n=>{let t=document.createElement("li");t.classList.add("channel"),t.dataset.channel=n.id;let s=document.createElement("span");if(s.classList.add("channel-name"),n.has_password){let a=document.createElement("i");a.className="fas fa-lock",a.style.marginRight="5px",a.title="此頻道需要密碼",s.appendChild(a)}s.appendChild(document.createTextNode(n.name)),t.appendChild(s);let i=document.createElement("span");i.classList.add("unread-indicator"),channelUnreadStatus[n.id]&&n.id!==currentChannel&&notificationSettings[n.id]&&i.classList.add("show"),t.appendChild(i),n.id===currentChannel&&t.classList.add("active"),t.addEventListener("click",()=>{n.has_password?showPasswordModal(n.id):switchChannel(n.id)}),e.appendChild(t)}),updateChannelButtons(),updateUnreadIndicators()}function showPasswordModal(e){let n=document.getElementById("password-modal"),t=document.getElementById("password-channel-id"),s=document.getElementById("channel-password");t.value=e;let a=channels.find(n=>n.id===e),i=a?a.name:"此頻道",o=document.querySelector("#password-modal p");o.textContent=`${i} 需要密碼才能訪問`;let l=JSON.parse(localStorage.getItem("channelPasswords")||"{}"),d=l[e];if(d||!checkpasswordflag){s.value=d,setTimeout(()=>{document.getElementById("password-form").dispatchEvent(new Event("submit"))},100);return}s.value="",n.classList.remove("hidden"),s.focus()}function handlePasswordForm(e){e.preventDefault();let n=document.getElementById("password-channel-id").value||currentChannel,t=JSON.parse(localStorage.getItem("channelPasswords")||"{}"),s=t[n]||document.getElementById("channel-password").value,a=e.target.querySelector('button[type="submit"]');a.disabled=!0,a.innerHTML="驗證中...",$.post(API_URL,{action:"verifyChannelPassword",data:JSON.stringify({channelId:n,password:s})}).done(function(e){if(e.success){let t=JSON.parse(localStorage.getItem("channelPasswords")||"{}");t[n]=s,localStorage.setItem("channelPasswords",JSON.stringify(t)),checkpasswordflag=!1,document.getElementById("password-modal").classList.add("hidden"),switchChannel(n)}else{showNotification("密碼驗證失敗："+(e.error||"密碼不正確"),"error");let a=JSON.parse(localStorage.getItem("channelPasswords")||"{}");a[n]="",localStorage.setItem("channelPasswords",JSON.stringify(a)),checkpasswordflag=!0,showPasswordModal(n)}}).fail(function(e){console.error("密碼驗證錯誤:",e),showNotification("密碼驗證請求失敗，請稍後再試","error")}).always(function(){a.disabled=!1,a.innerHTML="驗證"})}function showAddChannelModal(){document.getElementById("channel-modal-title").textContent="添加頻道",document.getElementById("channel-name").value="",document.getElementById("channel-id").value="",document.getElementById("channel-modal").classList.remove("hidden")}function showEditChannelModal(e){document.getElementById("channel-modal-title").textContent="編輯頻道",document.getElementById("channel-name").value=e.name,document.getElementById("channel-id").value=e.id;let n=document.getElementById("channel-password-option");n.checked=e.has_password,e.has_password?$.post(API_URL,{action:"getChannelPassword",data:JSON.stringify({id:e.id}),sessionId:adminSessionId}).done(function(e){if(e.success&&e.password){document.getElementById("channel-password-display").value=e.password,document.getElementById("password-display-group").classList.remove("hidden");let n=document.querySelector('#channel-form button[type="submit"]');n.innerHTML="複製並關閉"}}):document.getElementById("password-display-group").classList.add("hidden"),document.getElementById("channel-modal").classList.remove("hidden")}function handleChannelForm(e){e.preventDefault();let n=document.querySelector('#channel-form button[type="submit"]'),t=document.getElementById("channel-name").value,s=document.getElementById("channel-id").value,a=document.getElementById("channel-password-option"),i=document.getElementById("password-display-group");if(a.checked&&i.classList.contains("hidden")&&(n.innerHTML="產生密碼",n.disabled=!1),!i.classList.contains("hidden")){let o=document.getElementById("channel-password-display");navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(o.value).then(()=>{showNotification("密碼已複製到剪貼簿","success"),document.getElementById("channel-modal").classList.add("hidden"),i.classList.add("hidden"),n.innerHTML="儲存"}).catch(e=>{showNotification("無法複製密碼: "+e,"error")}):(showNotification("請手動複製密碼","info"),o.select());return}n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> 處理中...',s?updateChannel(s,t,n):addChannel(t,n)}function updateChannelHeader(){let e=document.querySelector(".channels-header h2"),n=channels.find(e=>e.id===currentChannel)?.name||"未知頻道";e.textContent=`頻道 [${n}]`}function deleteChannel(e){$.post(API_URL,{action:"deleteChannel",data:`{ "id": "${e}" }`,sessionId:adminSessionId}).done(function(n){if(n.success){let t=channels.findIndex(n=>n.id===e);-1!==t&&(channels.splice(t,1),updateChannelList(),currentChannel===e&&channels.length>0&&switchChannel(channels[0].id)),showNotification("頻道刪除成功！","success")}else showNotification("刪除頻道失敗："+(n.error||"未知錯誤"),"error")}).fail(function(e){console.error("刪除頻道錯誤:",e),showNotification("刪除頻道請求失敗，請稍後再試","error")})}document.getElementById("password-form").addEventListener("submit",handlePasswordForm);